<div fxLayout="row" fxLayout.lt-sm="column" fxLayoutAlign="space-around start" class="search-content">
  <div fxFlex="75" fxFlex.lt-sm="90">
    <div fxLayout="row" class ="header-row">
      <div class="section-header active">Structure Search</div>
    </div>
    <div fxLayout="row" fxLayout.lt-sm="column" fxLayoutAlign="start center" class ="sketcher-row">
      <div fxFlex="100">
        <app-sketcher></app-sketcher>
      </div>
    </div>
    <div fxLayout="row" fxLayout.lt-sm="column" fxLayoutAlign="start center">
      <div fxFlex="30">
        <mat-form-field class="full-width-field">
          <mat-select [formControl]="typeCtrl" (valueChange)="typeChanged($event)">
            <mat-option [value]="'sub'">Substructure</mat-option>
            <mat-option [value]="'sim'">Similarity</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div fxFlex="5"></div>
    </div>
    <div fxLayout="row" fxLayout.lt-sm="column" fxLayoutAlign="start center">
      <div fxFlex ="70">
        <mat-form-field class="full-width-field">
          <input matInput placeholder="structure" [formControl]="smilesCtrl" (change)="smilesChanged($event)">
        </mat-form-field>
      </div>
    </div>
    <div fxLayout="row">
      <div fxFlex="85">
        <button mat-raised-button [color]="'primary'" (click)="search()">Search <mat-icon>search</mat-icon></button>
      </div>
    </div>
  </div>
</div>

<script>

    $(function () {

      var IMAGE_DATA;
      var DATA = {}, $imgContainer = $("#image_container");
      $(":file").filestyle();
      $imgContainer.click(function () {
        $imgContainer.addClass('hilit-border');
      });
      $(document).click(function (event) {
        var $target = $(event.target);
        if (!$target.closest($imgContainer).length)
          $imgContainer.removeClass('hilit-border');
      })
      //-------------------use cache------------------------------------
      if (window.PREDICTION_DATA) {
        buildPredxResultTable(window.PREDICTION_DATA);
        $("#do_prediction_btn").prop('disabled', false);
      }

      //----------------------------Prediction---------------------------------------------
      function doPrediction(mol) {
        //cache
        window.MOL = mol;
        var $indictator = $("#prediction_indictor");
        $indictator.show();
        $.ajax({
          url: 'route/predict',
          data: mol,
          type: 'POST',
          dataType: 'json',
          contentType: 'text/plain;charset=UTF-8',
          success: function (data, status, xhr) {
            //cache
            window.PREDICTION_DATA = data;
            buildPredxResultTable(data);
            $indictator.hide();
          },
          error: function (xhr, status, error) {
            $indictator.hide();
            bootbox.alert('Prediction failed.');
          }
        })
      }

      function buildPredxResultTable(data) {
        var $predxContainer = $("#prediction_content");
        $predxContainer.show();
        PredxTable.build('predx_table', data);
        $('html, body').animate({scrollTop: ($predxContainer.offset().top - 100)}, "fast");

        //reset filters
        if (resetAllFilters)
          resetAllFilters();
      }

      //----------------------Sketcher------------------------------------------------------------------------
      var marvinSketcherInstance;
      var $doPredictionBtn = $("#do_prediction_btn");
      $doPredictionBtn.on("click", function (e) {
        if (marvinSketcherInstance.isEmpty()) {
          bootbox.alert('No structure draw/found!');
          return;
        }

        marvinSketcherInstance.exportStructure("mol").then(function (source) {
          doPrediction(source);
        }, function (error) {
          bootbox.alert('Molecule export failed.' + error);
        });
      });

      MarvinJSUtil.getEditor("#sketch_frame").then(function (sketcherInstance) {
          marvinSketcherInstance = sketcherInstance;

          marvinSketcherInstance.addButton({
            "name": "SDF",
            "image-url": "examples/images/sdf.jpg",
            "toolbar": "S"
          }, function () {
            if (marvinSketcherInstance.isEmpty()) {
              bootbox.alert('No SDF available!');
              return;
            }
            marvinSketcherInstance.exportStructure("mol").then(function (source) {
              //just in case the structure get edited, use edited sdf instead
              DATA.sdfFromSketcher = source;
              showCopyDiv('<pre>' + source + '</pre>', 'sdf');
            }, function (error) {
              bootbox.alert('Can not copy SDF');
            });
          });
          marvinSketcherInstance.addButton({
            "name": "SMILES",
            "image-url": "examples/images/smi.jpg",
            "toolbar": "S"
          }, function (e) {
            //how about edited structure?
            if (!DATA.smiles) {
              bootbox.alert('No SMILES available!');
              return;
            }
            showCopyDiv(DATA.smiles, 'smi');
          });

          marvinSketcherInstance.on('molchange', function () {
            if (marvinSketcherInstance.isEmpty()) {
            }//$structureSearchBtn.prop('disabled',true);
            else $doPredictionBtn.prop('disabled', false);
          });

        }, function (error) {
          bootbox.alert('Cannot retrieve sketcher instance from iframe.');
        }
      );
      window.clearSketch = function () {
        marvinSketcherInstance.clear();
        $doPredictionBtn.prop('disabled', true);
      }

      function importMolToSketcher(data) {
        //init
        DATA = {smiles: data.smiles, sdf: data.sdf, sdfFromSketcher: null};
        //console.log(data.sdf);
        marvinSketcherInstance.importStructure("mol", data.sdf).catch(function (error) {
          //If the sketcher cannot render the data.sdf, use data.smiles regenerate the sdf. Example: NCGC00016580-01
          if (data.smiles) convertText(data.smiles);
          else bootbox.alert('Cannot show the structure.');
        });
      }

      //----------------------Image transform------------------------------------------------------------------------
      var $processing = $("#processing_img");
      $imgContainer.filedrop({
        callback: function (fileEncryptedData) {
          var size = fileEncryptedData.length / (1024 * 1024);
          if (size > 2.5) {
            bootbox.alert('The input image exceeds the 2MB limit size.');
            return;
          }
          imgToMolToMarvinJs(fileEncryptedData);
        }
      });

      $("#struct_img_input").change(function (event) {
        var $this = $(this);
        var files = event.originalEvent.target.files || event.originalEvent.dataTransfer.files;
        try {
          var reader = new FileReader();
          reader.onload = function (event) {
            var fileEncryptedData = event.target.result;
            imgToMolToMarvinJs(fileEncryptedData)
          }
          reader.readAsDataURL(files[0]);
        } catch (e) {
          bootbox.alert('Error: seems File API is not supported on your browser');
        }
      });

      //select algorithm
      $('input[name="algorithm"]').change(function () {
        if (!IMAGE_DATA) return;
        imgToMolToMarvinJs(IMAGE_DATA)
      })

      function imgToMolToMarvinJs(fileEncryptedData) {
        IMAGE_DATA = fileEncryptedData;
        $processing.show();
        $imgContainer.css("background-image", 'url(' + fileEncryptedData + ')');

        var alg = $('input[name="algorithm"]:checked').val();
        var formData = new FormData();
        formData.append('algorithm', alg);
        formData.append('imgBase64', fileEncryptedData);

        $.ajax({
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          url: 'transform/image',
          success: function (data, status, xhr) {
            //console.log(data);
            $processing.hide();
            if (!data.sdf) {
              bootbox.alert('Cannot transform the image to structure');
              return
            }
            importMolToSketcher(data);
          },
          error: function (xhr, status, error) {
            $processing.hide();
            bootbox.alert('Cannot transform the image to structure');
          }
        });
      }

      //---------------------------------Paste image---------------------------------------------------------------
      var CLIPBOARD = new CLIPBOARD_CLASS('image_canvas', false);

      function CLIPBOARD_CLASS(actualImageCanvasId, autoresize) {
        var _self = this;
        var canvas = document.getElementById(actualImageCanvasId);
        var ctx = document.getElementById(actualImageCanvasId).getContext("2d");

        //handlers
        document.addEventListener('paste', function (e) {
          _self.paste_auto(e);
        }, false);

        //on paste
        this.paste_auto = function (e) {
          if (!$("#image_tab.active").length) {
            return;//for paste text
          }
          if (e.clipboardData) {
            var items = e.clipboardData.items;
            if (!items) return;
            //access data directly
            for (var i = 0; i < items.length; i++) {
              if (items[i].type.indexOf("image") !== -1) {
                //image
                var blob = items[i].getAsFile();
                var URLObj = window.URL || window.webkitURL;
                var source = URLObj.createObjectURL(blob);
                this.paste_createImage(source);
              }
            }
            e.preventDefault();
          }
        };
        //draw pasted image to canvas
        this.paste_createImage = function (source) {
          var pastedImage = new Image();
          pastedImage.src = source;

          pastedImage.onload = function () {
            //draw image for recognition. 'image_canvas'
            canvas.width = pastedImage.width;
            canvas.height = pastedImage.height;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, pastedImage.width, pastedImage.height);
            ctx.drawImage(pastedImage, 0, 0);
            var dataURL = canvas.toDataURL();
            imgToMolToMarvinJs(dataURL);
          };

          $imgContainer.removeClass('hilit-border')
        }
      }

      //----------------------Text transform------------------------------------------------------------------------
      var $textInput = $("#text_input"), $convertBtn = $("#text_convert_btn");
      $textInput.on('keypress', function (e) {
        if (e.keyCode == 13)
          $convertBtn.trigger("click");
      });
      $convertBtn.click(function () {
        var text = $textInput.val();
        if (text.trim().length <= 0) {
          bootbox.alert("Please input NCGC ID, Chemical Name, SMILES or SDF!");
          return;
        }
        convertText(text);
      });

      function showTransforming(show) {
        var $txt = $convertBtn.find('span');
        if (show) $txt.addClass('text-blink').html('CONVERTING......');
        else $txt.removeClass('text-blink').html('<i class="fa fa-cogs"></i> Convert ');
      }

      function convertText(text) {
        showTransforming(true);
        $.ajax({
          url: 'transform/text',
          data: text,
          type: 'POST',
          dataType: 'json',
          contentType: 'text/plain;charset=UTF-8',
          success: function (data, status, xhr) {
            //console.log(data);
            showTransforming(false);
            if (!data.sdf) {
              bootbox.alert("No structure available", function () {
              });
              return;
            }
            importMolToSketcher(data);
          },
          error: function (xhr, status, error) {
            showTransforming(false);
            bootbox.alert('Cannot get the structure');
          }
        });
      }

      $('#modelDetailModal').on('shown.bs.modal', function (e) {
        var $invoker = $(e.relatedTarget);
        var modelId = $invoker.attr('data-modelId');
        $.ajax({
          url: 'route/predict/model/byid/' + modelId,
          type: 'GET',
          dataType: 'json',
          success: function (data, status, xhr) {
            var refArr = data.references.split(/\|/);
            data.references = refArr;
            var infoHtml = Mustache.to_html($('#model_detail_template').html(), data);//cssjs.html
            $("#modelDetailModal").find('.modal-body').html(infoHtml);
          },
          error: function (xhr, status, error) {
            errorHandler(xhr, status, error);
          }
        });
      });
    })
  </script>
